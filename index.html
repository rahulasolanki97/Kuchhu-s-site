<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Loom Lyric ðŸ§¶</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Poppins',sans-serif;
  background:#001f4d;
  background-image:
    radial-gradient(circle at 20% 50%, rgba(170,212,255,0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(170,212,255,0.08) 0%, transparent 50%),
    radial-gradient(circle at 40% 20%, rgba(170,212,255,0.05) 0%, transparent 40%),
    repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(170,212,255,0.03) 35px, rgba(170,212,255,0.03) 70px);
  background-attachment:fixed;
  color:#fff;
  margin:0;
  padding:20px;
}
h1,h2{text-align:center;}
.tagline{text-align:center;color:#aad4ff;margin-bottom:30px;}
.products{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:20px;
}
.card{
  background:#fff;
  color:#000;
  border-radius:15px;
  padding:15px;
  box-shadow:0 5px 15px rgba(0,0,0,0.2);
}
.card img{
  width:100%;
  height:250px;
  object-fit:cover;
  border-radius:12px;
}
.price{font-weight:bold;color:#001f4d;}
.oldprice{
  text-decoration:line-through;
  color:#555;
  font-size:14px;
}
.whatsapp{
  display:block;
  background:#25D366;
  color:#fff;
  padding:10px;
  text-align:center;
  border-radius:8px;
  text-decoration:none;
  margin-top:10px;
}
.instagram{
  display:block;
  background:#C13584;
  color:#fff;
  padding:10px;
  text-align:center;
  border-radius:8px;
  text-decoration:none;
  margin-top:10px;
}
.admin{
  background:#00264d;
  margin-top:40px;
  padding:20px;
  border-radius:15px;
  display:none;
}
input,textarea,button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ccc;
}
input[type=file]{border:none;}
button{
  background:#aad4ff;
  color:#001f4d;
  border:none;
  cursor:pointer;
  font-weight:bold;
}
button:disabled{
  opacity:0.5;
  cursor:not-allowed;
}
.manage{
  background:#003366;
  padding:10px;
  margin:8px 0;
  border-radius:8px;
}
.footer{
  text-align:center;
  margin-top:40px;
  font-size:13px;
  color:#aad4ff;
  cursor:pointer;
}
label{font-size:13px;color:#aad4ff;}
#logoPreview{
  display:block;
  width:120px;
  height:120px;
  margin:10px auto;
  object-fit:cover;
  border:4px solid #aad4ff;
  border-radius:50%;
  box-shadow:0 5px 20px rgba(170,212,255,0.3);
}
.loading{
  text-align:center;
  padding:20px;
  color:#aad4ff;
}
.error{
  background:#ff4444;
  color:#fff;
  padding:10px;
  border-radius:8px;
  margin:10px 0;
  text-align:center;
}
</style>
</head>

<body>

<!-- LOGO -->
<img id="logoPreview" src="" alt="Logo" style="display:none;">

<h1>Loom Lyric ðŸ§¶</h1>
<p class="tagline">Stitching melody in every loop</p>

<div class="loading" id="loading">Loading products...</div>

<h2>Our Handmade Products</h2>
<div class="products" id="products"></div>

<!-- LOGIN -->
<div class="admin" id="loginBox">
  <h2>Admin Login</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<!-- ADMIN PANEL -->
<div class="admin" id="adminPanel">
  <h2>Admin Dashboard</h2>
  <div id="adminError"></div>

  <hr style="border-color:#aad4ff;margin:20px 0;">

  <!-- Logo Upload -->
  <label>Upload / Change Logo</label>
  <input type="file" id="logo" accept="image/*">
  <button onclick="uploadLogo()">Update Logo</button>

  <!-- WhatsApp number update -->
  <label>WhatsApp Number</label>
  <input id="whatsappNumber" placeholder="Enter number with country code (e.g., 919876543210)">
  <button onclick="updateWhatsApp()">Update WhatsApp Number</button>

  <!-- Instagram ID update -->
  <label>Instagram ID</label>
  <input id="instagramInput" placeholder="Enter Instagram ID">
  <button onclick="updateInstagram()">Update Instagram ID</button>

  <hr style="border-color:#aad4ff;margin:20px 0;">

  <h3>Add New Product</h3>
  <input id="name" placeholder="Product Name">
  <input id="price" placeholder="Normal Price">
  <input id="specialPrice" placeholder="Special Price (optional)">
  
  <label>Special Price Start</label>
  <input type="date" id="startDate">
  <label>Special Price End</label>
  <input type="date" id="endDate">

  <textarea id="desc" placeholder="Description"></textarea>
  <input type="file" id="image" accept="image/*">
  <button onclick="addProduct()">Add Product</button>
  <button onclick="logout()">Logout</button>

  <h3>Manage Products</h3>
  <div id="manage"></div>
</div>

<div class="footer" onclick="toggleLogin()">Admin Access</div>

<script>
/* ===== CONFIGURATION ===== */
const USERNAME = "Harshali";
const PASSWORD = "Harshali@123";

// PUT YOUR GOOGLE APPS SCRIPT WEB APP URL HERE (between the quotes)
const API_URL = "https://script.google.com/macros/s/AKfycbxzxDJt69RWtkfIgQtPyhWd_kt6DvKTUlg3ImW55K_EjJWOmbr84WQqFaSih0fSDAO5/exec";

/* ===== ELEMENTS ===== */
const productsDiv = document.getElementById("products");
const manageDiv = document.getElementById("manage");
const adminPanel = document.getElementById("adminPanel");
const loginBox = document.getElementById("loginBox");
const loadingDiv = document.getElementById("loading");
const adminError = document.getElementById("adminError");

/* ===== DATA ===== */
let products = [];
let settings = {
  logo: "",
  whatsappNumber: "91YOURNUMBER",
  instagramID: "loom__lyric"
};

/* ===== API FUNCTIONS ===== */
async function loadData() {
  if (!API_URL) {
    loadingDiv.innerHTML = '<p style="color:#ff4444;">Error: API URL not configured in the code. Contact admin.</p>';
    return;
  }

  try {
    // Load products
    const prodResponse = await fetch(`${API_URL}?action=getProducts`);
    const prodData = await prodResponse.json();
    products = prodData.products || [];

    // Load settings
    const settingsResponse = await fetch(`${API_URL}?action=getSettings`);
    const settingsData = await settingsResponse.json();
    settings = {
      logo: settingsData.logo || "",
      whatsappNumber: settingsData.whatsappNumber || "91YOURNUMBER",
      instagramID: settingsData.instagramID || "loom__lyric"
    };

    loadingDiv.style.display = "none";
    render();
    renderLogo();
  } catch (error) {
    console.error("Error loading data:", error);
    loadingDiv.innerHTML = '<p class="error">Failed to load data. Please check your API URL.</p>';
  }
}

async function saveToSheet(action, data) {
  if (!API_URL) {
    showError("Please set API URL first");
    return false;
  }

  try {
    const response = await fetch(`${API_URL}?action=${action}`, {
      method: 'POST',
      body: JSON.stringify(data)
    });
    const result = await response.json();
    return result.success;
  } catch (error) {
    console.error("Error saving:", error);
    showError("Failed to save. Check console for details.");
    return false;
  }
}

/* ===== LOGO ===== */
function renderLogo() {
  const preview = document.getElementById("logoPreview");
  if (settings.logo) {
    preview.src = settings.logo;
    preview.style.display = "block";
  } else {
    preview.style.display = "none";
  }
}

async function uploadLogo() {
  const file = document.getElementById("logo").files[0];
  if (!file) {
    alert("Select a logo");
    return;
  }

  const reader = new FileReader();
  reader.onload = async function() {
    const success = await saveToSheet('updateSettings', { logo: reader.result });
    if (success) {
      settings.logo = reader.result;
      renderLogo();
      alert("Logo updated!");
    }
  };
  reader.readAsDataURL(file);
}

/* ===== SETTINGS UPDATE ===== */
async function updateWhatsApp() {
  const num = document.getElementById("whatsappNumber").value.trim();
  if (!num) {
    alert("Enter a valid number");
    return;
  }

  const success = await saveToSheet('updateSettings', { whatsappNumber: num });
  if (success) {
    settings.whatsappNumber = num;
    alert("WhatsApp number updated!");
    document.getElementById("whatsappNumber").value = "";
    render();
  }
}

async function updateInstagram() {
  const id = document.getElementById("instagramInput").value.trim();
  if (!id) {
    alert("Enter a valid Instagram ID");
    return;
  }

  const success = await saveToSheet('updateSettings', { instagramID: id });
  if (success) {
    settings.instagramID = id;
    alert("Instagram ID updated!");
    document.getElementById("instagramInput").value = "";
    render();
  }
}

/* ===== HELPERS ===== */
function currentPrice(p) {
  const now = new Date().toISOString().split("T")[0];
  if (p.specialPrice && p.startDate && p.endDate) {
    if (now >= p.startDate && now <= p.endDate) {
      return { price: p.specialPrice, old: p.price };
    }
  }
  return { price: p.price };
}

function showError(msg) {
  adminError.innerHTML = `<p class="error">${msg}</p>`;
  setTimeout(() => adminError.innerHTML = "", 5000);
}

/* ===== RENDER ===== */
function render() {
  let userHTML = "", adminHTML = "";
  
  if (products.length === 0) {
    userHTML = "<p style='text-align:center;'>No products yet</p>";
  }

  products.forEach((p, i) => {
    const cp = currentPrice(p);

    userHTML += `
      <div class="card">
        <img src="${p.image}" alt="${p.name}">
        <h3>${p.name}</h3>
        ${cp.old ? `<p class="oldprice">â‚¹${cp.old}</p><p class="price">â‚¹${cp.price}</p>` : `<p class="price">â‚¹${cp.price}</p>`}
        <p>${p.desc || ""}</p>
        <a class="whatsapp"
          href="https://wa.me/${settings.whatsappNumber}?text=I want to order ${encodeURIComponent(p.name)}">
          Order on WhatsApp
        </a>
        <a class="instagram"
          href="https://www.instagram.com/${settings.instagramID}" target="_blank">
          Contact on Instagram
        </a>
      </div>`;

    adminHTML += `
      <div class="manage">
        <b>${p.name}</b> - â‚¹${p.price}<br>
        <button onclick="editProduct(${i})">Edit</button>
        <button onclick="deleteProduct(${i})">Delete</button>
      </div>`;
  });

  productsDiv.innerHTML = userHTML;
  manageDiv.innerHTML = adminHTML;
}

/* ===== ADMIN ACCESS ===== */
function toggleLogin() {
  loginBox.style.display = loginBox.style.display === "block" ? "none" : "block";
}

function login() {
  const user = document.getElementById("username").value;
  const pass = document.getElementById("password").value;
  
  if (user === USERNAME && pass === PASSWORD) {
    loginBox.style.display = "none";
    adminPanel.style.display = "block";
  } else {
    alert("Wrong login");
  }
}

function logout() {
  adminPanel.style.display = "none";
}

/* ===== ADD PRODUCT ===== */
async function addProduct() {
  const nameInput = document.getElementById("name");
  const priceInput = document.getElementById("price");
  const file = document.getElementById("image").files[0];

  if (!nameInput.value || !priceInput.value) {
    alert("Please enter product name and price");
    return;
  }

  if (!file) {
    alert("Please select an image");
    return;
  }

  const reader = new FileReader();
  reader.onload = async function() {
    const productData = {
      name: nameInput.value,
      price: priceInput.value,
      specialPrice: document.getElementById("specialPrice").value,
      startDate: document.getElementById("startDate").value,
      endDate: document.getElementById("endDate").value,
      desc: document.getElementById("desc").value,
      image: reader.result
    };

    const success = await saveToSheet('addProduct', productData);
    if (success) {
      alert("Product added!");
      // Clear form
      nameInput.value = "";
      priceInput.value = "";
      document.getElementById("specialPrice").value = "";
      document.getElementById("startDate").value = "";
      document.getElementById("endDate").value = "";
      document.getElementById("desc").value = "";
      document.getElementById("image").value = "";
      
      // Reload data
      await loadData();
    }
  };
  reader.readAsDataURL(file);
}

/* ===== DELETE ===== */
async function deleteProduct(i) {
  if (!confirm("Delete this product?")) return;

  const success = await saveToSheet('deleteProduct', { index: i });
  if (success) {
    alert("Product deleted!");
    await loadData();
  }
}

/* ===== EDIT ===== */
async function editProduct(i) {
  const p = products[i];
  const n = prompt("Product Name:", p.name);
  const pr = prompt("Normal Price:", p.price);
  const sp = prompt("Special Price (leave empty if none):", p.specialPrice || "");

  if (n && pr) {
    const success = await saveToSheet('updateProduct', {
      index: i,
      name: n,
      price: pr,
      specialPrice: sp,
      startDate: p.startDate,
      endDate: p.endDate,
      desc: p.desc
    });

    if (success) {
      alert("Product updated!");
      await loadData();
    }
  }
}

/* ===== INITIAL LOAD ===== */
loadData();
</script>

</body>
</html>
